<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=1920" />
        <title>Aola Viewer</title>
        <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/YieldRay/hashRouter/src/router.min.js"></script>
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                min-height: 100vh;
            }
            input,
            button {
                font-size: 2em;
                padding: 1.5em 3em;
            }
            header {
                text-align: center;
                margin-top: 2.5em;
            }
            .rotate {
                margin-top: 30em;
                transform: rotate(0.25turn);
            }
            .spine-player {
                pointer-events: none !important;
            }
            .spine-player-controls {
                pointer-events: auto !important;
            }
        </style>
    </head>
    <body>
        <main id="app">
            <header>
                <div class="control">
                    <input v-model="id" placeholder="Edit me" />
                    <button @click="change">Change</button>
                </div>
                <div class="control">
                    <button @click="change(id-1)">- Prev</button>
                    &nbsp;
                    <button @click="rotate" :class="{debugrotate: isRotate}">Rotate</button>
                    &nbsp;
                    <button @click="change(id+1)">Next +</button>
                </div>
            </header>
            <div id="player"></div>
        </main>
    </body>
    <script>
        function loadStyle(url) {
            let link = document.createElement("link");
            link.rel = "stylesheet";
            link.type = "text/css";
            link.href = url;
            let head = document.getElementsByTagName("head")[0];
            head.appendChild(link);
        }

        function loadScript(url) {
            return new Promise((resolve, reject) => {
                let script = document.createElement("script");
                script.src = url;
                let head = document.getElementsByTagName("head")[0];
                head.appendChild(script);
                script.onload = () => resolve();
                script.onerror = () => reject();
            });
        }
        function sleep(time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }
        const app = new Vue({
            el: "#app",
            data: {
                id: 4412,
                res: {},
                version: "3.7",
                isRotate: false,
            },
            methods: {
                change: async function (n) {
                    if (typeof n === "number") {
                        this.id = Number(n);
                    }
                    if ($router.path != this.id) $router.path = String(this.id);
                    document.title = `Aola View ${this.id}`;
                    this.res = await fetch(
                        `http://aola.100bt.com/h5/peticon/newbreath/petmovie${this.id}/petmovie${this.id}~202112241640285894.json`
                    ).then((res) => res.json());
                    this.version = this.res.skeleton.spine.slice(0, 3);
                    await loadScript(`./spine-player-${this.version}.js`);
                    loadStyle(`./spine-player-${this.version}.css`);
                    player.remove();
                    let div = document.createElement("div");
                    div.id = "player";
                    document.body.append(div);
                    new spine.SpinePlayer("player", {
                        jsonUrl: `http://aola.100bt.com/h5/peticon/newbreath/petmovie${this.id}/petmovie${this.id}~202112241640285894.json`,
                        atlasUrl: `http://aola.100bt.com/h5/peticon/newbreath/petmovie${this.id}/petmovie${this.id}~202112241640285894.atlas`,
                        animation: "0",
                        backgroundColor: "#ffffff",
                        showControls: false, // Hide the player controls
                        premultipliedAlpha: false,
                        viewport: {
                            width: 100,
                            height: 100,
                        },
                    });
                },
                rotate: function () {
                    this.isRotate = !!!this.isRotate;
                    window.document.querySelector(".spine-player-canvas").classList.toggle("rotate");
                },
            },
            mounted: function () {
                const id = Number($router.path);
                if (id > 1000 && id < 5000) this.change(id);
            },
        });
    </script>
</html>
